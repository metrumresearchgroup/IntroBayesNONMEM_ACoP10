      SUBROUTINE MUMODEL2(THETA,MU_,ICALL,IDEF,NEWIND,&
      EVTREC,DATREC,IREV,NVNT,INDXS,F,G,H,IRGG,GG,NETAS)
      USE NMPRD4P
      USE SIZES,     ONLY: DPSIZE,ISIZE
      USE PRDIMS,    ONLY: GPRD,HPRD,GERD,HERD,GPKD
      USE NMBAYES_REAL,    ONLY: PRIORINFO
      USE NMPRD_REAL,ONLY: ETA,EPS
      USE NMPRD_INT, ONLY: IERPRD,IERPRDU,NETEXT,IQUIT
      USE NMPRD_CHAR,ONLY: ETEXT
      USE NMPRD_INT, ONLY: I_REC=>IRECRSIV
      USE NMPR_INT,  ONLY: RPTI=>NRPT_IN,RPTO=>NRPT_OUT,RPTON=>NRPT_ON,PRDFL=>IUSEPRD
      USE ROCM_REAL, ONLY: THETAF,OMEGAF,SIGMAF,THETAFR
      USE ROCM_REAL, ONLY: SETHET=>SETH,SEOMEG=>SEOM,SESIGM=>SESIG,SETHETR=>SETHR
      USE ROCM_REAL, ONLY: OBJECT
      USE ROCM_INT,  ONLY: IERE=>IEST_ERR,IERC=>ICOV_ERR
      USE NMPRD_REAL, ONLY: CORRL2
      USE ROCM_INT,  ONLY: NREP,IREP=>NCREP
      USE ROCM_INT,  ONLY: MIXNUM=>MIXCALL,MIXEST=>IMIXEST
      USE ROCM_REAL, ONLY: MIXP
      USE NMPRD_INT, ONLY: MSEC=>ISECDER,MFIRST=>IFRSTDER,IFIRSTEM
      USE NMPRD_INT, ONLY: MDVRES,ETASXI,NPDE_MODE,NOFIRSTDERCODE
      USE NMPRD_REAL, ONLY: DV_LOQ,CDF_L,DV_LAQ,CDF_LA
      USE NMPRD_INT, ONLY: NPROB,IPROB,IDXSUP,NITR_SUP,NITSUP
      USE NMPRD_INT, ONLY: NEWL2
      USE ROCM_REAL, ONLY: TEMPLT=>VRAW
      USE ROCM_INT,  ONLY: NIREC=>NINDREC,NDREC=>NDATINDR
      USE ROCM_INT,  ONLY: NINDR=>NINDOBS,INDR1=>IDXOBSF,INDR2=>IDXOBSL
      USE ROCM_INT,  ONLY: LIREC=>NDATPASS
      USE ROCM_REAL, ONLY: APPND
      USE NMPR_REAL, ONLY: YLO,YUP
      USE NMPR_REAL, ONLY: CTLO=>CTLW,DCTLO=>DCTLW,DDCTLO=>DDCTLW
      USE NMPR_REAL, ONLY: CTUP,DCTUP,DDCTUP
      USE NMPR_INT,  ONLY: SKIP_=>SKIP
      USE NMPR_REAL, ONLY: THSIMP=>THET_P,OMSIMP=>OMEG_P,SGSIMP=>SIGM_P,THSIMPR
      USE ROCM_REAL, ONLY: DEN_NP
      USE NMPR_INT,  ONLY: F_FLAG=>IPRDFLG1
      USE ROCM_REAL, ONLY: OMEGA=>VARNF
      USE NMPRD_INT, ONLY: NTHES_=>NWTHT,NETAS_=>NWETA,NEPSS_=>NWEPS
      USE ROCM_REAL, ONLY: PR_Y
      USE ROCM_REAL, ONLY: PR_CT
      USE ROCM_REAL, ONLY: IIDX=>DIDVALX
      USE ROCM_REAL, ONLY: CNTID=>OFV_IND
      USE CMNM1_INT, ONLY: NIND_7=>NIND
      USE NMPRD_INT, ONLY: COMACT,COMSAV
      USE NMBAYES_REAL, ONLY: LDF
      USE NMPRD_INT, ONLY: U06,U29,UST
      USE ROCM_REAL, ONLY: MIXPT=>MIXP_RAW
      USE NM_INTERFACE, ONLY: TFI
      USE NM_INTERFACE, ONLY: TFD
      USE NMPRD_INT, ONLY: MDV100
      USE NMPRD_INT, ONLY: MDVI1
      USE NMPRD_INT, ONLY: MDVI2
      USE NMPRD_INT, ONLY: MDVI3
      USE NMPRD_INT, ONLY: NTHETA
      USE NMPRD_INT, ONLY: NREC
      USE NMPRD_REAL, ONLY: DB
      USE NMPRD_REAL, ONLY: LB
      USE NMPRD_REAL, ONLY: UB
      USE CMNM1_INT, ONLY: NIND
      USE CMNM2_INT, ONLY: ICOMPRS
      USE CMNM2_REAL, ONLY: SPEC
      USE CMNM2_INT, ONLY: NOBSIND
      USE CMNM2_INT, ONLY: NRECIND
      USE ROCM_INT, ONLY: FIRSTREC
      USE ROCM_INT, ONLY: LASTREC
      USE ROCM_INT, ONLY: FIRSTOBS
      USE ROCM_INT, ONLY: LASTOBS
      USE ROCM_INT, ONLY: FIRSTDOS
      USE ROCM_INT, ONLY: LASTDOS
      USE ROCM_INT, ONLY: EFIRSTREC
      USE ROCM_INT, ONLY: ELASTREC
      USE ROCM_INT, ONLY: EFIRSTOBS
      USE ROCM_INT, ONLY: ELASTOBS
      USE ROCM_INT, ONLY: EFIRSTDOS
      USE ROCM_INT, ONLY: ELASTDOS
      USE CMNM2_INT ,ONLY: IRECIDX
      USE NMPRD_REAL, ONLY: EPS73
      USE NMPRD_REAL, ONLY: REPS
      USE NMPRD_REAL, ONLY: TOL
      USE NMPRD_REAL, ONLY: INFNTY
      USE NMPRD_REAL, ONLY: SQINFN
      USE CMNM7_REAL, ONLY: SREPS
      USE CMNM7_REAL, ONLY: STOL
      USE CMNM4_INT, ONLY: MAXDREC
      USE CMNM4_REAL, ONLY: SMALL
      USE VERSION, ONLY: LEV
      USE NMPRD_INT, ONLY: NPROB
      USE NMPRD_INT, ONLY: IPROB
      USE ROCM_REAL, ONLY: SIGD
      USE NMPRD_INT, ONLY: IPRNV
      USE NMPRD_INT, ONLY: IPS
      USE ROCM_INT, ONLY: NINDREC
      USE ROCM_INT, ONLY: NDATINDR
      USE ROCM_INT, ONLY: NINDOBS
      USE NMPRD_INT, ONLY: IDPROB
      USE CMNM2_INT, ONLY: NOBSIND_MAX
      USE NM_BAYES_INT, ONLY: ISEED
      USE NM_BAYES_INT, ONLY: IRANM
      USE NM_BAYES_REAL, ONLY: MEPS
      USE NMDATA, ONLY: PI
      USE NM_BAYES_INT, ONLY: IKEY_PITER
      USE NM_BAYES_INT, ONLY: IKEY_TERM
      USE NMBAYES_INT, ONLY: ITERATION
      USE NMBAYES_INT, ONLY: ITER_REPORT
      USE NMBAYES_INT, ONLY: NPAT
      USE NMBAYES_INT, ONLY: SAEM_MODE
      USE NMBAYES_INT, ONLY: ITS_MODE
      USE NMBAYES_INT, ONLY: IMP_MODE
      USE NMBAYES_INT, ONLY: PITERPRINT
      USE NMBAYES_REAL, ONLY: OBJI
      USE NMBAYES_CHAR, ONLY: SBANNER
      USE NMBAYES_INT, ONLY: IBMETHOD
      USE NMBAYES_INT, ONLY: BAYES_METHOD
      USE EST_DEFS, ONLY: EST_STANDARD
      USE EST_DEFS, ONLY: EST_DEFAULT
      USE EST_DEFS, ONLY: EST_DIRECT
      USE EST_DEFS, ONLY: EST_BAYES
      USE EST_DEFS, ONLY: EST_ITS
      USE EST_DEFS, ONLY: EST_IMP
      USE EST_DEFS, ONLY: EST_IMPMAP
      USE EST_DEFS, ONLY: EST_SAEM
      USE EST_DEFS, ONLY: EST_CHAIN
      USE NMBAYES_INT, ONLY: EST_COUNTER
      USE NMBAYES_INT, ONLY: IEST_COUNTER
      USE NMBAYES_REAL, ONLY: DHPRIOR
      USE NMBAYES_REAL, ONLY: LDF
      USE NMBAYES_INT, ONLY: ITABLE
      USE NMBAYES_INT, ONLY: BAYES_EXTRA_REQUEST
      USE NMBAYES_INT, ONLY: BAYES_EXTRA
      USE NMBAYES_INT, ONLY: PATCOUNT
      USE NMBAYES_INT, ONLY: CONSTRAIN
      USE NM_BAYES_INT, ONLY: IKEY_SUBJ
      USE NM_BAYES_INT, ONLY: IKEY_BEOPRINT
      USE PNM_CONFIG, ONLY: PNM_RUN_MODE
      USE PNM_CONFIG, ONLY: PNM_NODE_NUMBER
      USE PNM_CONFIG, ONLY: PNM_NODES
      USE PNM_CONFIG, ONLY: PNM_COMPUTERS
      USE PNM_CONFIG, ONLY: PNM_PARAPRINT
      USE PNM_CONFIG, ONLY: PNM_SPLIT
      USE PNM_CONFIG, ONLY: PNM_PARSE_NUMBER
      USE PNM_CONFIG, ONLY: PNM_TRANSFER_TYPE
      USE PNM_CONFIG, ONLY: PNM_TIMEOUTI
      USE PNM_CONFIG, ONLY: PNM_TIMEOUT
      USE PNM_CONFIG, ONLY: PNM_COMMAND
      USE PNM_CONFIG, ONLY: PNM_WORKER_DIRS
      USE PNM_CONFIG, ONLY: PNM_MTOUCH
      USE PNM_CONFIG, ONLY: PNM_MSLEEP
      USE PNM_CONFIG, ONLY: PNM_WTOUCH
      USE PNM_CONFIG, ONLY: PNM_WSLEEP
      USE NMBAYES_CHAR, ONLY: RANMETHOD
      USE NMBAYES_CHAR, ONLY: SRANMETHOD
      USE NMBAYES_CHAR, ONLY: TRANMETHOD
      USE NMBAYES_CHAR, ONLY: CRANMETHOD
      USE NMBAYES_CHAR, ONLY: CCRANMETHOD
      USE NMBAYES_INT, ONLY: ETASTYPE
      USE NMPRD_INT, ONLY: NETAZ
      USE NMPRD_INT, ONLY: NEPSZ
      USE NMBAYES_REAL, ONLY: OMEGANNL
      USE NM_BAYES_INT, ONLY: NM_STEP,BASE_STEP,EST_STEP,COV_STEP,TABLE_STEP,SIML_STEP,INE_STEP,&
&NONP_STEP
      USE NMBAYES_INT, ONLY: MUFIRSTREC
      USE NMBAYES_INT, ONLY: OBJQUICK
      USE CVIDAROOT, ONLY: NRTFN,NRTCT,RTINFO,RTSIGNAL,TRTINFO,YRTINFO,YPRTINFO,GRTINFO
      IMPLICIT REAL(KIND=DPSIZE) (A-Z)
      REAL(KIND=DPSIZE)   :: MU_(*)
      REAL(KIND=DPSIZE) :: DATREC
 991  FORMAT (35F14.4)
 992  FORMAT (35E15.7)
 998  FORMAT (1PE22.15,1X,1PE22.15/)
      SAVE
      INTEGER(KIND=ISIZE) :: ICALL,NEWIND,INDXS
      REAL(KIND=DPSIZE) :: G(GPRD,*),H(HPRD,*)
      DIMENSION :: THETA(*),DATREC(*),INDXS(*)
      INTEGER(KIND=ISIZE) :: FIRSTEM
      INTEGER(KIND=ISIZE), POINTER :: S1NUM, S2NUM, S1NIT, S2NIT, S1IT, S2IT
      REAL(KIND=DPSIZE), POINTER :: PRED_
      REAL(KIND=DPSIZE), POINTER :: RES_
      REAL(KIND=DPSIZE), POINTER :: WRES_
      REAL(KIND=DPSIZE), POINTER :: IWRS_
      REAL(KIND=DPSIZE), POINTER :: IPRD_
      REAL(KIND=DPSIZE), POINTER :: IRS_
      REAL(KIND=DPSIZE), POINTER :: NPRED_
      REAL(KIND=DPSIZE), POINTER :: NRES_
      REAL(KIND=DPSIZE), POINTER :: NWRES_
      REAL(KIND=DPSIZE), POINTER :: NIWRES_
      REAL(KIND=DPSIZE), POINTER :: NIPRED_
      REAL(KIND=DPSIZE), POINTER :: NIRES_
      REAL(KIND=DPSIZE), POINTER :: CPRED_
      REAL(KIND=DPSIZE), POINTER :: CRES_
      REAL(KIND=DPSIZE), POINTER :: CWRES_
      REAL(KIND=DPSIZE), POINTER :: CIWRES_
      REAL(KIND=DPSIZE), POINTER :: CIPRED_
      REAL(KIND=DPSIZE), POINTER :: CIRES_
      REAL(KIND=DPSIZE), POINTER :: PREDI_
      REAL(KIND=DPSIZE), POINTER :: RESI_
      REAL(KIND=DPSIZE), POINTER :: WRESI_
      REAL(KIND=DPSIZE), POINTER :: IWRESI_
      REAL(KIND=DPSIZE), POINTER :: IPREDI_
      REAL(KIND=DPSIZE), POINTER :: IRESI_
      REAL(KIND=DPSIZE), POINTER :: CPREDI_
      REAL(KIND=DPSIZE), POINTER :: CRESI_
      REAL(KIND=DPSIZE), POINTER :: CWRESI_
      REAL(KIND=DPSIZE), POINTER :: CIWRESI_
      REAL(KIND=DPSIZE), POINTER :: CIPREDI_
      REAL(KIND=DPSIZE), POINTER :: CIRESI_
      REAL(KIND=DPSIZE), POINTER :: EPRED_
      REAL(KIND=DPSIZE), POINTER :: ERES_
      REAL(KIND=DPSIZE), POINTER :: EWRES_
      REAL(KIND=DPSIZE), POINTER :: EIWRES_
      REAL(KIND=DPSIZE), POINTER :: EIPRED_
      REAL(KIND=DPSIZE), POINTER :: EIRES_
      REAL(KIND=DPSIZE), POINTER :: NPDE_
      REAL(KIND=DPSIZE), POINTER :: ECWRES_
      REAL(KIND=DPSIZE), POINTER :: NPD_
      REAL(KIND=DPSIZE), POINTER :: OBJI_
      REAL(KIND=DPSIZE), POINTER :: DEN_,CDEN_(:)
! MIXPT=>MIXP_RAW:  Mixture probabilities for data-average block
! TFI:  function converts integer argument i to text: TFI(i)
! TFD:  function converts double precision argument d to text: TFD(d)
! MDV100: =0 if no MDV data itme, =1 if original MDV in data set is 0 or 1, =2 if original MDV in data set is 100 or 101
! MDVI1: DO not ignore MDV>100 records in OBJ routine
! MDVI2: DO not ignore MDV>100 records in OBJ2 routine
! MDVI3: DO not ignore MDV>100 records in OBJ3 routine
! NTHETA: Length of theta; may be set to 1 when length is 0
! DB: Upper bound minus lower bound (UB(I)-LB(I))
! LB: LB(I)=Lower bound for THETA(I)
! UB: UB(I)=Upper bound for THETA(I)
! NIND: Total number of individuals; set in INPT
! ICOMPRS: 0 = usual format for var-covar output, 1 = compressed format
! modified such that 0 = usual format, 9 or fewer elements, 1 = usual format more than 9 elements and 2 = compressed format
! SPEC:  = 1E10, used as a flag in var-covar
! NOBSIND: Number of observation records in individual record
! NRECIND: No. of records / this individual;
! NREC: No. of records in entire dataset;
! number of data records in individual record
! the following 12 items can be compared against NDREC
! FIRSTREC: first record of subject
! LASTREC: last record of subject
! FIRSTOBS: first observation record of subject (for which MDV=0 or 100)
! LASTOBS: last observation record of subject (for which MDV=0 or 100)
! FIRSTDOS: First record of subject with EVID=1 or EVID=4.  FIRSTDOS=-1 when there are no dose records, or PREDPP is not used.
! LASTDOS: Last record of subject with EVID=1 or EVID=4.  LASTDOS=-1 when there are no dose records, or PREDPP is not used.
! EFIRSTREC: first record of subject during estimation (so, among records for which MDV=0 or MDV=1)
! ELASTREC: last record of subject during estimation (so, among records for which MDV=0 or MDV=1)
! EFIRSTOBS: first observation record of subject  during estimation (so, among records for which MDV=0)
! ELASTOBS: last observation record of subject during estimation (so, among records for which MDV=0)
! EFIRSTDOS: First record of subject with EVID=1 or EVID=4 during estimation (so, among records for which MDV=1).  EFIRSTDOS=-1 if no dose record PREDPP is not
! ELASTDOS: Last record of subject with EVID=1 or EVID=4  during estimation (so, among records for which MDV=1).  ELASTDOS=-1 if no dose record PREDPP is not us
! IRECIDX: IRECIDX+1 is starting absolute record number in the data set for the present subject (so while NDREC always sets to 1 for the first record of each su
! During ICALL=1 (INFN initialization), ICALL=3 (INFN finalization), or ICALL=4 (simulation)
! only FIRSTREC and LASTREC are available.  The other values will be set to -1.
! EPS73: Mantissa length.  This is the number 2**(-m), where m is the number of binary digits occurring in the double precision mantissa.
! REPS: Same as REPST; Machine precision. Smallest double precision number that when added to 1 yields a number that is not 1 (same as MEPS)
! TOL: same as TOLT
! INFNTY: SQRT (LARGET); LARGET is largest double precision number representable by the machine
! SQINFN: SQRT (INFNTY)
! SREPS: same as SREPST
! STOL: same as STOLT
! MAXDREC: Maximum number of data record for an individual up to & including this individual
! SMALL: SQRT(TOL*REPS)
! LEV: Level of release
! NPROB: Number of problems
! IPROB: The number of the current problem
! SIGD: minimum value of significant digits; min(DIFA)
! IPRNV: 0 = no printing of NONMEM input info. after 1st iteration of active 1st(2nd) level super problem
! 1 = normal printing for active 1st (2nd) level super problem.
! IPS: Indicator variable,
! 1-> Population data,
! 2-> Single-subject data
! NINDREC (alias NIREC): The number of the individual record at current call (this the subject number)
! NDATINDR (alias NDREC): The number of the data record within the individual record at the current call
! NINDOBS: Number of individual records containing an observation record
! IDPROB: Problem ID
! NOBSIND_MAX: Maximum number of observations for any subject
! ISEED: Present seed number of ranmethods 0-3
! IRANM: Random method for Monte Carlo EM methods
! MEPS: Machine double precision (typically about 1.0E-15)
! PI: Contains the number PI
! IKEY_PITER: =1 to printer iterations, in response to ctrl-I, or signal file iter.sig
! IKEY_TERM: =5 to end run, in response to ctrl-E, or stop.sig file
! =11 to end mode, in response to ctrl-K, or next.sig file
! ITERATION: Present iteration of an EM/Bayesian Method (always non-negative).
! ITER_REPORT: Iteration number that is reported to output (can be negative, if during a burn period).
! NPAT: Number of subjects that have data
! SAEM_MODE: =0 Bayes method
! =1 Stochastic period of SAEM, IMP, ITS, DIRECT, IMPMAP
! =2 reduced stochastic/accumulative period of SAEM
! ITS_MODE: =0 no MAP estimation
! =1 MAP estimation on first iteration
! =2 MAP estimation all iterations (IMPMAP)
! =3 ITS
! IMP_MODE: =0 no Monte Carlo  importance sampling
! =1 Monte Carlo importance sampling
! PITERPRINT: =1 print iteration information
! =0 don’t print iteration information
! OBJI: OBJI(NIREC,1)= objective function value for subject NIREC
! SBANNER: Text to stimation method
! IBMETHOD: Holds METHOD type
! EST_* are defined in module EST_DEFS
! EST_STANDARD (FO/FOCE/LaPLCE)
! EST_DIRECT
! EST_BAYES
! EST_ITS
! EST_SAEM
! EST_IMP
! EST_IMPMAP
! EST_CHAIN
! BAYES_METHOD: ==0 FOR REGULAR BAYES, =1 FOR NUTS
! EST_COUNTER: Total number of $EST statements.
! IEST_COUNTER: Present $EST statement being executed.
! DHPRIOR: Prior portion for EM methods
! LDF: LDF(i)=Loss of degrees of freedom for omega i (usually=1)..  Used in correction for EM analyses only.
! ITABLE: Table number (#TBLN in NONMEM report file, and table numbers in extra output files, such as .ext, .phi, .phm, etc.)
! BAYES_EXTRA_REQUEST: See example8
! BAYES_EXTRA: See example8
! PATCOUNT: Number of subjects with data
! CONSTRAIN: CONSTRAIN setting by which CONSTRAINT routine responds
! IKEY_SUBJ: IF IKEY_SUBJ=20, then ctrl-T or subject.sig signal
! IKEY_BEOPRINT: Toggle to ctrl-B or sending paraprint.sig file.
! PNM_RUN_MODE: May have values:
! PNM_MANAGER
! PNM_WORKER
! PNM_SINGLE
! PNM_NODE_NUMBER: 1=MANAGER,  or SINGLE
! 2-PNM_NODES=WORKER
! PNM_NODES: Number of NODES
! PNM_COMPUTERS: COMPUTERS setting in pnm file
! PNM_PARAPRINT: PARAPRINT setting in pnm file
! PNM_SPLIT: PARSE_TYPE setting in pnm file
! PNM_PARSE_NUMBER: PARSE_NUM
! PNM_TRANSFER_TYPE: TRANSFER_TYPE
! PNM_TIMEOUTI: TIMEOUTI
! PNM_TIMEOUT: TIMEOUT
! PNM_COMMAND: Array pnm commands
! PNM_WORKER_DIRS: Array with worker directories (1-nodes-1)
! PNM_MTOUCH: MTOUCH
! PNM_MSLEEP: MSLEEP
! PNM_WTOUCH: WTOUCH
! PNM_WSLEEP: WSLEEP
! RANMETHOD: $EST RANMETHOD
! SRANMETHOD: $SIML RANMETHOD
! TRANMETHOD: $TABLE RANMETHOD
! CRANMETHOD: $EST METHOD=CHAIN RANMETHOD
! CCRANMETHOD: $CHAIN RANMETHOD
! ETASTYPE: ETASTYPE
! NETAZ: Maximum eta index to have non-zero OMEGA diagonal
! NEPSZ: Maximum eps index to have non-zero SIGMA diagonal
! OMEGANNL: For each x,y in
! $ANNEAL x:y
! OMEGANNL(x)=y
! Those not defined in $ANNEAL are set to -1
! Used in CONSTRAINT.f90
! NM_STEP CAN HAVE THE FOLLOWING VALUES: BASE_STEP, EST_STEP,COV_STEP,TABLE_STEP,SIML_STEP,INE_STEP,NONP_STEP
! MUFIRSTREC: SET TO 1 IN $PK OR $PRED TO CAUSE COVARIATES OF ONLY FIRST RECORD OF SUBJECT TO BE USED IN ASSESSING MU
! OBJQUICK: SET TO 1 IN $PRED OR $PK TO USE QUICK CODE FOR NOUTURN SAMPLING.  ONLY SIMPLE MODELS, WITH NO $MIX, OR $LEVEL
! CVIDAROOT USED FOR ADVAN14 (SEE CVODEU.F90 COMMENTS), OR ADVAN15 (SEE IDAU.F90 COMMENTS) FOR ROOT FINDING
      FIRSTEM=IFIRSTEM
      S1NUM=>IDXSUP(1)
      S2NUM=>IDXSUP(2)
      S1NIT=>NITR_SUP(1)
      S2NIT=>NITR_SUP(2)
      S1IT=>NITSUP(1)
      S2IT=>NITSUP(2)
      DEN_=>DEN_NP(1)
      CDEN_=>DEN_NP(2:)
      PRED_=>APPND(001)
      RES_=>APPND(002)
      WRES_=>APPND(003)
      IWRS_=>APPND(004)
      IPRD_=>APPND(005)
      IRS_=>APPND(006)
      NPRED_=>APPND(007)
      NRES_=>APPND(008)
      NWRES_=>APPND(009)
      NIWRES_=>APPND(010)
      NIPRED_=>APPND(011)
      NIRES_=>APPND(012)
      CPRED_=>APPND(013)
      CRES_=>APPND(014)
      CWRES_=>APPND(015)
      CIWRES_=>APPND(016)
      CIPRED_=>APPND(017)
      CIRES_=>APPND(018)
      PREDI_=>APPND(019)
      RESI_=>APPND(020)
      WRESI_=>APPND(021)
      IWRESI_=>APPND(022)
      IPREDI_=>APPND(023)
      IRESI_=>APPND(024)
      CPREDI_=>APPND(025)
      CRESI_=>APPND(026)
      CWRESI_=>APPND(027)
      CIWRESI_=>APPND(028)
      CIPREDI_=>APPND(029)
      CIRESI_=>APPND(030)
      EPRED_=>APPND(031)
      ERES_=>APPND(032)
      EWRES_=>APPND(033)
      EIWRES_=>APPND(034)
      EIPRED_=>APPND(035)
      EIRES_=>APPND(036)
      NPDE_=>APPND(037)
      ECWRES_=>APPND(038)
      NPD_=>APPND(039)
      OBJI_=>APPND(040)
      IF (ICALL <= 1) CALL ASSOCNMPRD4
      IF (ICALL == 4) THEN
      IF (NEWIND /= 2) THEN
      CALL SIMETA(ETA)
      IF (IQUIT == 1) RETURN
      ENDIF
      IF (NEWL2 == 1) THEN
      CALL SIMEPS(EPS)
      IF (IQUIT == 1) RETURN
      ENDIF
      ELSE
      IF (NEWIND /= 2) THEN
      CALL GETETA(ETA)
      IF (IQUIT == 1) RETURN
       EPS(001)=0.D0
      ENDIF
      ENDIF
 !  level            0           0
      CONC=DATREC(005)
      BAYES_EXTRA_REQUEST=1.D0
      nThin=THETA(005)
      MU_1=THETA(001)
      MU_(001)=MU_1
      MU_2=THETA(002)
      MU_(002)=MU_2
      MU_3=THETA(003)
      MU_(003)=MU_3
      MU_4=THETA(004)
      MU_(004)=MU_4
       RETURN
      CALL EXTRASEND()
      LGT_EMAX=MU_1+ETA(001)
      B000001=-LGT_EMAX
      B000003=DEXP(B000001)
      B000002=1.D0+B000003
      EMAX=100.D0/B000002
      B000007=MU_2+ETA(002)
      B000008=DEXP(B000007)
      EC50=B000008
      B000009=MU_3+ETA(003)
      B000010=DEXP(B000009)
      GAMMA=B000010
      B000011=MU_4+ETA(004)
      B000012=DEXP(B000011)
      SD=B000012
      IF(CONC == 0.D0.AND.GAMMA <= 0.D0)THEN
      IERPRD=1
      ETEXT(1)='PRED SUBROUTINE: ERROR IN COMPUTATION'
      ETEXT(2)='ATTEMPT TO COMPUTE 0**POWER WITH POWER<=0.'
      NETEXT=2
      RETURN
      ENDIF
      IF(CONC <  0.D0)THEN
      IERPRD=1
      ETEXT(1)='PRED SUBROUTINE: ERROR IN COMPUTATION'
      ETEXT(2)='ATTEMPT TO COMPUTE BASE**POWER WITH BASE<0.'
      NETEXT=2
      RETURN
      ENDIF
      B000013=0.D0
      IF(CONC == 0.D0)THEN
      B000013=1.D0
      ENDIF
      B000014=1.D0-B000013
      B000015=CONC+B000013
      B000016=B000015**GAMMA
      B000017=B000014*B000016
      IF(EC50 == 0.D0.AND.GAMMA <= 0.D0)THEN
      IERPRD=1
      ETEXT(1)='PRED SUBROUTINE: ERROR IN COMPUTATION'
      ETEXT(2)='ATTEMPT TO COMPUTE 0**POWER WITH POWER<=0.'
      NETEXT=2
      RETURN
      ENDIF
      IF(EC50 <  0.D0)THEN
      IERPRD=1
      ETEXT(1)='PRED SUBROUTINE: ERROR IN COMPUTATION'
      ETEXT(2)='ATTEMPT TO COMPUTE BASE**POWER WITH BASE<0.'
      NETEXT=2
      RETURN
      ENDIF
      B000018=0.D0
      IF(EC50 == 0.D0)THEN
      B000018=1.D0
      ENDIF
      B000019=1.D0-B000018
      B000020=EC50+B000018
      B000021=B000020**GAMMA
      B000022=B000019*B000021
      IF(CONC == 0.D0.AND.GAMMA <= 0.D0)THEN
      IERPRD=1
      ETEXT(1)='PRED SUBROUTINE: ERROR IN COMPUTATION'
      ETEXT(2)='ATTEMPT TO COMPUTE 0**POWER WITH POWER<=0.'
      NETEXT=2
      RETURN
      ENDIF
      IF(CONC <  0.D0)THEN
      IERPRD=1
      ETEXT(1)='PRED SUBROUTINE: ERROR IN COMPUTATION'
      ETEXT(2)='ATTEMPT TO COMPUTE BASE**POWER WITH BASE<0.'
      NETEXT=2
      RETURN
      ENDIF
      B000023=0.D0
      IF(CONC == 0.D0)THEN
      B000023=1.D0
      ENDIF
      B000024=1.D0-B000023
      B000025=CONC+B000023
      B000026=B000025**GAMMA
      B000027=B000024*B000026
      B000028=B000022+B000027
      RESP=EMAX*B000017/B000028
      Y=RESP+SD*EPS(001)
!                      C000031 = DERIVATIVE OF Y W.R.T. EPS(001)
      C000031=SD
      B000057=ITER_REPORT/nThin
      B000059=ITER_REPORT/nThin
      B000058=INT(B000059)
      IF(BAYES_EXTRA == 1.D0.AND.NIREC == 1.D0.AND.NDREC == 1.D0.AND. &
      ITER_REPORT >  0.D0.AND.B000057 == B000058)THEN
      IF(FIRST_WRITE_PAR == 0.D0)THEN
      OPEN(unit=52,FILE='./par.txt')
      FIRST_WRITE_PAR=1.D0
      ENDIF
      WRITE(52,'(I12,1X,5(1X,1PG19.10E3))') ITER_REPORT, &
      THETA(1), THETA(2), THETA(3), THETA(4)
      ENDIF
      IF (FIRSTEM == 1) THEN !1
!                      A000032 = DERIVATIVE OF B000001 W.R.T. ETA(001)
      A000032=-1.D0
!                      A000033 = DERIVATIVE OF B000003 W.R.T. ETA(001)
      A000033=B000003*A000032
      B000004=-100.D0/B000002/B000002
!                      A000035 = DERIVATIVE OF EMAX W.R.T. ETA(001)
      A000035=B000004*A000033
      B000029=DLOG(B000015)
      B000030=B000029*B000016
!                      A000057 = DERIVATIVE OF B000016 W.R.T. ETA(003)
      A000057=B000030*B000010
!                      A000058 = DERIVATIVE OF B000017 W.R.T. ETA(003)
      A000058=B000014*A000057
      B000031=GAMMA-1.D0
      B000032=B000020**B000031
      B000033=B000032*GAMMA
!                      A000060 = DERIVATIVE OF B000021 W.R.T. ETA(002)
      A000060=B000033*B000008
      B000034=DLOG(B000020)
      B000035=B000034*B000021
!                      A000061 = DERIVATIVE OF B000021 W.R.T. ETA(003)
      A000061=B000035*B000010
!                      A000063 = DERIVATIVE OF B000022 W.R.T. ETA(003)
      A000063=B000019*A000061
!                      A000064 = DERIVATIVE OF B000022 W.R.T. ETA(002)
      A000064=B000019*A000060
      B000037=DLOG(B000025)
      B000038=B000037*B000026
!                      A000065 = DERIVATIVE OF B000026 W.R.T. ETA(003)
      A000065=B000038*B000010
!                      A000066 = DERIVATIVE OF B000027 W.R.T. ETA(003)
      A000066=B000024*A000065
!                      A000069 = DERIVATIVE OF B000028 W.R.T. ETA(003)
      A000069=A000066+A000063
      B000039=B000017/B000028
!                      A000070 = DERIVATIVE OF RESP W.R.T. ETA(001)
      A000070=B000039*A000035
      B000040=EMAX/B000028
!                      A000071 = DERIVATIVE OF RESP W.R.T. ETA(003)
      A000071=B000040*A000058
      B000041=-EMAX*B000017/B000028/B000028
!                      A000072 = DERIVATIVE OF RESP W.R.T. ETA(003)
      A000072=B000041*A000069+A000071
!                      A000073 = DERIVATIVE OF RESP W.R.T. ETA(002)
      A000073=B000041*A000064
!                      A000135 = DERIVATIVE OF Y W.R.T. ETA(002)
      A000135=A000073
!                      A000136 = DERIVATIVE OF Y W.R.T. ETA(003)
      A000136=A000072
!                      A000137 = DERIVATIVE OF Y W.R.T. ETA(001)
      A000137=A000070
!                      A000138 = DERIVATIVE OF Y W.R.T. ETA(004)
      A000138=EPS(001)*B000012
!                      A000146 = DERIVATIVE OF C000031 W.R.T. ETA(004)
      A000146=B000012
      G(001,1)=A000137
      G(002,1)=A000135
      G(003,1)=A000136
      G(004,1)=A000138
      ENDIF !1
      IF (MSEC == 1) THEN
!                      A000036 = DERIVATIVE OF A000033 W.R.T. ETA(001)
      A000036=A000032*A000033
      B000005=100.D0/B000002/B000002/B000002
!                      A000038 = DERIVATIVE OF B000004 W.R.T. ETA(001)
      A000038=B000005*A000033
      B000006=100.D0/B000002/B000002/B000002
!                      A000039 = DERIVATIVE OF B000004 W.R.T. ETA(001)
      A000039=B000006*A000033+A000038
!                      A000040 = DERIVATIVE OF A000035 W.R.T. ETA(001)
      A000040=A000033*A000039
!                      A000041 = DERIVATIVE OF A000035 W.R.T. ETA(001)
      A000041=B000004*A000036+A000040
!                      A000075 = DERIVATIVE OF B000030 W.R.T. ETA(003)
      A000075=B000029*A000057
!                      A000076 = DERIVATIVE OF A000057 W.R.T. ETA(003)
      A000076=B000010*A000075
!                      A000077 = DERIVATIVE OF A000057 W.R.T. ETA(003)
      A000077=B000030*B000010+A000076
!                      A000078 = DERIVATIVE OF A000058 W.R.T. ETA(003)
      A000078=B000014*A000077
      B000043=B000031-1.D0
      B000044=B000020**B000043
      B000045=B000044*B000031
!                      A000081 = DERIVATIVE OF B000032 W.R.T. ETA(002)
      A000081=B000045*B000008
      B000046=DLOG(B000020)
      B000047=B000046*B000032
!                      A000082 = DERIVATIVE OF B000032 W.R.T. ETA(003)
      A000082=B000047*B000010
!                      A000083 = DERIVATIVE OF B000033 W.R.T. ETA(003)
      A000083=GAMMA*A000082
!                      A000084 = DERIVATIVE OF B000033 W.R.T. ETA(002)
      A000084=GAMMA*A000081
!                      A000085 = DERIVATIVE OF B000033 W.R.T. ETA(003)
      A000085=B000032*B000010+A000083
!                      A000086 = DERIVATIVE OF A000060 W.R.T. ETA(003)
      A000086=B000008*A000085
!                      A000087 = DERIVATIVE OF A000060 W.R.T. ETA(002)
      A000087=B000008*A000084
!                      A000088 = DERIVATIVE OF A000060 W.R.T. ETA(002)
      A000088=B000033*B000008+A000087
      B000048=1.D0/B000020
!                      A000089 = DERIVATIVE OF B000034 W.R.T. ETA(002)
      A000089=B000048*B000008
!                      A000090 = DERIVATIVE OF B000035 W.R.T. ETA(002)
      A000090=B000021*A000089
!                      A000091 = DERIVATIVE OF B000035 W.R.T. ETA(003)
      A000091=B000034*A000061
!                      A000092 = DERIVATIVE OF B000035 W.R.T. ETA(002)
      A000092=B000034*A000060+A000090
!                      A000093 = DERIVATIVE OF A000061 W.R.T. ETA(003)
      A000093=B000010*A000091
!                      A000094 = DERIVATIVE OF A000061 W.R.T. ETA(003)
      A000094=B000035*B000010+A000093
!                      A000097 = DERIVATIVE OF A000063 W.R.T. ETA(003)
      A000097=B000019*A000094
!                      A000098 = DERIVATIVE OF A000064 W.R.T. ETA(002)
      A000098=B000019*A000088
!                      A000099 = DERIVATIVE OF A000064 W.R.T. ETA(003)
      A000099=B000019*A000086
!                      A000100 = DERIVATIVE OF B000038 W.R.T. ETA(003)
      A000100=B000037*A000065
!                      A000101 = DERIVATIVE OF A000065 W.R.T. ETA(003)
      A000101=B000010*A000100
!                      A000102 = DERIVATIVE OF A000065 W.R.T. ETA(003)
      A000102=B000038*B000010+A000101
!                      A000103 = DERIVATIVE OF A000066 W.R.T. ETA(003)
      A000103=B000024*A000102
!                      A000108 = DERIVATIVE OF A000069 W.R.T. ETA(003)
      A000108=A000097+A000103
      B000049=1.D0/B000028
!                      A000109 = DERIVATIVE OF B000039 W.R.T. ETA(003)
      A000109=B000049*A000058
      B000050=-B000017/B000028/B000028
!                      A000110 = DERIVATIVE OF B000039 W.R.T. ETA(003)
      A000110=B000050*A000069+A000109
!                      A000111 = DERIVATIVE OF B000039 W.R.T. ETA(002)
      A000111=B000050*A000064
!                      A000112 = DERIVATIVE OF A000070 W.R.T. ETA(002)
      A000112=A000035*A000111
!                      A000113 = DERIVATIVE OF A000070 W.R.T. ETA(003)
      A000113=A000035*A000110
!                      A000114 = DERIVATIVE OF A000070 W.R.T. ETA(001)
      A000114=B000039*A000041
      B000051=1.D0/B000028
!                      A000115 = DERIVATIVE OF B000040 W.R.T. ETA(001)
      A000115=B000051*A000035
      B000052=-EMAX/B000028/B000028
!                      A000116 = DERIVATIVE OF B000040 W.R.T. ETA(003)
      A000116=B000052*A000069
!                      A000117 = DERIVATIVE OF B000040 W.R.T. ETA(002)
      A000117=B000052*A000064
!                      A000118 = DERIVATIVE OF A000071 W.R.T. ETA(003)
      A000118=A000058*A000116
!                      A000119 = DERIVATIVE OF A000071 W.R.T. ETA(003)
      A000119=B000040*A000078+A000118
      B000053=-B000017/B000028/B000028
!                      A000120 = DERIVATIVE OF B000041 W.R.T. ETA(001)
      A000120=B000053*A000035
      B000054=-EMAX/B000028/B000028
!                      A000121 = DERIVATIVE OF B000041 W.R.T. ETA(003)
      A000121=B000054*A000058
      B000055=EMAX*B000017/B000028/B000028/B000028
!                      A000122 = DERIVATIVE OF B000041 W.R.T. ETA(003)
      A000122=B000055*A000069+A000121
!                      A000123 = DERIVATIVE OF B000041 W.R.T. ETA(002)
      A000123=B000055*A000064
      B000056=EMAX*B000017/B000028/B000028/B000028
!                      A000124 = DERIVATIVE OF B000041 W.R.T. ETA(003)
      A000124=B000056*A000069+A000122
!                      A000125 = DERIVATIVE OF B000041 W.R.T. ETA(002)
      A000125=B000056*A000064+A000123
!                      A000126 = DERIVATIVE OF A000072 W.R.T. ETA(003)
      A000126=A000069*A000124
!                      A000127 = DERIVATIVE OF A000072 W.R.T. ETA(003)
      A000127=B000041*A000108+A000126
!                      A000128 = DERIVATIVE OF A000072 W.R.T. ETA(003)
      A000128=A000119+A000127
!                      A000129 = DERIVATIVE OF A000073 W.R.T. ETA(002)
      A000129=A000064*A000125
!                      A000130 = DERIVATIVE OF A000073 W.R.T. ETA(003)
      A000130=A000064*A000124
!                      A000131 = DERIVATIVE OF A000073 W.R.T. ETA(002)
      A000131=B000041*A000098+A000129
!                      A000132 = DERIVATIVE OF A000073 W.R.T. ETA(003)
      A000132=B000041*A000099+A000130
!                      A000139 = DERIVATIVE OF A000135 W.R.T. ETA(003)
      A000139=A000132
!                      A000140 = DERIVATIVE OF A000135 W.R.T. ETA(002)
      A000140=A000131
!                      A000141 = DERIVATIVE OF A000136 W.R.T. ETA(003)
      A000141=A000128
!                      A000142 = DERIVATIVE OF A000137 W.R.T. ETA(001)
      A000142=A000114
!                      A000143 = DERIVATIVE OF A000137 W.R.T. ETA(003)
      A000143=A000113
!                      A000144 = DERIVATIVE OF A000137 W.R.T. ETA(002)
      A000144=A000112
!                      A000145 = DERIVATIVE OF A000138 W.R.T. ETA(004)
      A000145=EPS(001)*B000012
!                      A000142 = 2ND DERIV OF F W.R.T. ETA(001), ETA(001)
      G(001,002)=A000142
!                      A000144 = 2ND DERIV OF F W.R.T. ETA(002), ETA(001)
      G(002,002)=A000144
!                      A000140 = 2ND DERIV OF F W.R.T. ETA(002), ETA(002)
      G(002,003)=A000140
!                      A000143 = 2ND DERIV OF F W.R.T. ETA(003), ETA(001)
      G(003,002)=A000143
!                      A000139 = 2ND DERIV OF F W.R.T. ETA(003), ETA(002)
      G(003,003)=A000139
!                      A000141 = 2ND DERIV OF F W.R.T. ETA(003), ETA(003)
      G(003,004)=A000141
!                      A000145 = 2ND DERIV OF F W.R.T. ETA(004), ETA(004)
      G(004,005)=A000145
      ENDIF
      H(001,1)=C000031
      IF (FIRSTEM == 1) THEN !2
      H(001,005)=A000146
      ENDIF !2
      F=Y
      RETURN
      END
